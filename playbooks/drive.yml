---
- name: drive; Get invadelabs.com-bkup-latest.tar.xz backup
  shell: |
    rclone copyto googledrive:/Backup/Web/$(rclone ls googledrive:/Backup/Web 2>&1 | awk -F" " '{ print $2 }' | grep -E '^invadelabs.com.*.tar.xz$' | sort | tail -n 1) /srv/invadelabs.com-bkup-latest.tar.xz
  args:
    chdir: /root
    creates: /srv/invadelabs.com-bkup-latest.tar.xz
  when: ansible_fqdn == 'invadelabs.com'

- name: drive; Extract invadelabs.com-bkup-latest.tar.xz
  unarchive:
    src: /srv/invadelabs.com-bkup-latest.tar.xz
    dest: /srv
    remote_src: yes
    creates: /var/www/data/drew_wiki.sqlite
  when: ansible_fqdn == 'invadelabs.com'

- name: drive; copy /home/drew/letsencrypt /etc/letsencrypt
  shell: |
    rm -rf /etc/letsencrypt
    mv /srv/letsencrypt /etc
  args:
    creates: /etc/letsencrypt/live
  when: ansible_fqdn == 'invadelabs.com'

- name: drive; mkdir /var/www/data
  file:
    path: /var/www/data
    state: directory
    owner: www-data
    group: www-data
  when: ansible_fqdn == 'invadelabs.com'

- name: drive; mv /home/drew/drew_wiki.sqlite /var/www/data
  shell: |
    mv /srv/drew_wiki.sqlite /var/www/data
    chown www-data:www-data /var/www/data/drew_wiki.sqlite
  args:
    creates: /var/www/data/drew_wiki.sqlite
  when: ansible_fqdn == 'invadelabs.com'

- name: drive; mkdir /var/www/drew.invadelabs.com
  file:
    path: /var/www/drew.invadelabs.com
    state: directory
    owner: www-data
    group: www-data
  when: ansible_fqdn == 'invadelabs.com'

- name: drive; mkdir -p /var/www/drew.invadelabs.com; mv /home/drew/LocalSettings.php /var/www/drew.invadelabs.com
  shell: |
    mv /srv/LocalSettings.php /var/www/drew.invadelabs.com
    chown www-data:www-data /var/www/drew.invadelabs.com/LocalSettings.php
  args:
    creates: /var/www/drew.invadelabs.com/LocalSettings.php
  when: ansible_fqdn == 'invadelabs.com'
