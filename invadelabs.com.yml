---
- hosts: gce
  become: true
  become_method: sudo
  # gather_facts: no
  vars:
    rsyslog_host: localhost
    rsyslog_port: 11514

  tasks:
  - name: fail if hostname not set to invadelabs.com
    fail:
      msg: "Host name is not set to invadelabs.com! Run; hostnamectl set-hostname invadelabs.com"
    when: ansible_fqdn != "invadelabs.com"

  - name: stat required files in /root
    stat:
      path: "{{item}}"
    with_items:
      - /root/apache_env
      - /root/github_token
      - /root/postfix_passwd
      - /root/slacktee.conf
    register: item
    failed_when: item.stat.exists == False

  - name: check if drive initalized
    shell: touch /var/log/drive-init.touch; drive quota >/dev/null
    args:
      chdir: /root
      creates: /var/log/drive-init.touch
    register: drive_stat
    failed_when: drive_stat.rc != 0 # rc = proccess exit code

  - include: playbooks/initial.yml # etckeeper, fail2ban, ansible bits
  - include: playbooks/sshd_config.yml # sshd_config
  - include: playbooks/logging.yml # sshd_config
  - include: playbooks/nrpe.yml # sshd_config
  - include: playbooks/pkgs_debian.yml # all software bits needed
  - include: playbooks/postfix.yml # sendgrid relay config
  - include: playbooks/drive.yml # initalize drive, configures letsencrypt
  - include: playbooks/letsencrypt.yml # setup certbot
  - include: playbooks/apache2.yml # a2enmod, a2ensite, apache2.conf
  - include: playbooks/deploy_invadelabs.com.yml # initial invadelabs.com deploy
  - include: playbooks/deploy_drew.invadelabs.com.yml # DrewWiki depoy with googleAnalytics, OpenGraphMeta, Descript2, lock down versions
  - include: playbooks/cron.yml

  handlers:
  - name: Start apache2.service
    service: name=apache2 state=started enabled=yes
  - name: Start php7.2-fpm.service
    service: name=php7.2-fpm.service state=started enabled=yes
  - name: Start postfix.service
    service: name=postfix state=started enabled=yes

  - name: Restart nagios-nrpe-server.service
    service: name=nagios-nrpe-server state=restarted
  - name: Restart rsyslog.service
    service: name=rsyslog state=restarted
  - name: Restart systemd-journald.service
    service: name=systemd-journald state=restarted
  - name: Restart sshd.service
    service: name=sshd state=restarted
  - name: Restart sshguard.service
    service: name=sshguard state=restarted
  - name: Restart apache2.service
    service: name=apache2 state=restarted
  - name: Restart postfix.service
    service: name=postfix state=restarted

  - name: apache2; set env variables
    shell: grep {{item}} /root/apache_env | awk -F '"' '{print $2}'
    with_items:
      - deploy_env
      - email_env
      - slack_env
    register: apache_env_vars # XXX Fix this for invadelabs.com.conf.j2 temlate
    no_log: true
    notify: apache2; add site templates

  #- debug:
  #    msg: "{{ apache_env_vars.results[0].stdout }}"

  # apahce2 vhosts
  - name: apache2; add site templates
    template:
      src: templates/etc/apache2/sites-available/{{item}}.conf.j2
      dest: /etc/apache2/sites-available/{{item}}.conf
    with_items:
      - drew.invadelabs.com
      - invadelabs.com
      - www.invadelabs.com
    no_log: true
    notify:
      - apache2; a2ensite templates
      - Restart apache2.service

  # XXX https://github.com/ansible/ansible-modules-extras/pull/1240 use this module when finished
  - name: apache2; a2ensite templates
    command: a2ensite {{item}}
    args:
      creates: /etc/apache2/sites-enabled/{{item}}.conf
    with_items:
      - drew.invadelabs.com
      - invadelabs.com
      - www.invadelabs.com
    notify: Restart apache2.service

  roles:
  # - { role: tersmitten.swapfile, swapfile_size: 1GB, swapfile_swappiness: 10 } # XXX run this last
  # - { role: mongrelion.docker, userland-proxy: false }
